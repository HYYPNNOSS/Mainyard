generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  image         String?
  role          Role      @default(CUSTOMER)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bookingsAsCustomer Booking[]        @relation("customer")
  residentProfile    ResidentProfile?
  reviews            Review[]
  orders             Order[]          @relation("customer") // New: for product purchases

  @@map("users")
}

model ResidentProfile {
  id          String  @id @default(cuid())
  userId      String  @unique
  bio         String? @db.Text
  description String? @db.Text

  // Business Type Selection
  businessType BusinessType @default(SERVICES) // NEW: Choose between services or products

  // Basic Info
  title             String?
  location          String?
  yearsOfExperience Int?
  certifications    String? @db.Text
  languages         String?

  // Pricing & Booking (for SERVICES type)
  price          Float   @default(50)
  bookingEnabled Boolean @default(true)
  approved       Boolean @default(false)
  featured       Boolean @default(false)

  instantBooking     Boolean @default(false)
  cancellationPolicy String? @db.Text
  businessHours      String?

  // Social & Contact
  website     String?
  phone       String?
  socialLinks String? @db.Text

  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  availabilities Availability[]
  bookings       Booking[]
  payments       Payment[]
  images         ResidentImage[]
  services       Service[]
  reviews        Review[]
  categories     Category[]       // NEW: Custom categories created by resident
  products       Product[]        // NEW: Products for sale

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("resident_profiles")
}

// NEW: Custom categories created by residents
model Category {
  id          String   @id @default(cuid())
  residentId  String
  name        String   // e.g., "Aromatherapy Massage", "Organic Skincare"
  description String?  @db.Text
  type        CategoryType // Services or Products
  order       Int      @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  resident ResidentProfile @relation(fields: [residentId], references: [id], onDelete: Cascade)
  services Service[]
  products Product[]

  @@index([residentId])
  @@map("categories")
}

// NEW: Products model for residents selling physical/digital products
model Product {
  id          String   @id @default(cuid())
  residentId  String
  categoryId  String?  // Links to custom category
  name        String
  description String?  @db.Text
  price       Float
  compareAtPrice Float? // Original price for showing discounts
  sku         String?  // Stock Keeping Unit
  
  // Inventory
  trackInventory Boolean @default(false)
  stock          Int?    @default(0)
  lowStockAlert  Int?    // Alert when stock reaches this number
  
  // Product details
  weight      Float?   // in kg/lbs
  dimensions  String?  // JSON: {length, width, height}
  isDigital   Boolean  @default(false)
  
  // Visibility
  enabled     Boolean  @default(true)
  featured    Boolean  @default(false)
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  resident      ResidentProfile @relation(fields: [residentId], references: [id], onDelete: Cascade)
  category      Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images        ProductImage[]
  orderItems    OrderItem[]
  productReviews ProductReview[]

  @@index([residentId])
  @@index([categoryId])
  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  order     Int     @default(0)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// NEW: Orders for product purchases
model Order {
  id         String      @id @default(cuid())
  customerId String
  residentId String
  
  // Pricing
  subtotal      Float
  shippingCost  Float   @default(0)
  tax           Float   @default(0)
  total         Float
  
  // Shipping
  shippingAddress String? @db.Text // JSON with address details
  trackingNumber  String?
  
  status     OrderStatus @default(PENDING)
  notes      String?     @db.Text
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  customer   User        @relation("customer", fields: [customerId], references: [id], onDelete: Cascade)
  items      OrderItem[]
  payment    OrderPayment?

  @@index([customerId])
  @@map("orders")
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float  // Price at time of purchase

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderPayment {
  id               String        @id @default(cuid())
  orderId          String        @unique
  stripePaymentId  String
  amount           Float
  platformFee      Float
  residentEarnings Float
  status           PaymentStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_payments")
}

// NEW: Product reviews (separate from service reviews)
model ProductReview {
  id         String   @id @default(cuid())
  productId  String
  customerId String
  orderId    String?  
  rating     Int      // 1-5
  comment    String?  @db.Text
  response   String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product  Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_reviews")
}

model ResidentImage {
  id         String          @id @default(cuid())
  url        String
  residentId String
  resident   ResidentProfile @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([residentId])
  @@map("resident_images")
}

model Availability {
  id         String          @id @default(cuid())
  residentId String
  dayOfWeek  Int             @db.SmallInt
  startTime  String
  endTime    String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  resident   ResidentProfile @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@unique([residentId, dayOfWeek])
  @@map("availabilities")
}

model Booking {
  id         String        @id @default(cuid())
  residentId String
  customerId String
  date       DateTime      @db.Date
  timeSlot   String
  status     BookingStatus @default(PENDING)
  notes      String?
  totalPrice Float?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  customer User             @relation("customer", fields: [customerId], references: [id], onDelete: Cascade)
  resident ResidentProfile  @relation(fields: [residentId], references: [id], onDelete: Cascade)
  payment  Payment?
  services BookingService[]
  review   Review?

  @@unique([residentId, date, timeSlot])
  @@index([customerId])
  @@map("bookings")
}

model BookingService {
  id        String @id @default(cuid())
  bookingId String
  serviceId String
  quantity  Int    @default(1)

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([bookingId, serviceId])
  @@index([serviceId])
  @@map("booking_services")
}

model Review {
  id         String   @id @default(cuid())
  residentId String
  customerId String
  bookingId  String?  @unique
  rating     Int
  comment    String?  @db.Text
  response   String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  booking  Booking?        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resident ResidentProfile @relation(fields: [residentId], references: [id], onDelete: Cascade)
  customer User            @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([residentId])
  @@index([customerId])
  @@map("reviews")
}

model Service {
  id          String   @id @default(cuid())
  residentId  String
  categoryId  String?  // NEW: Links to custom category
  name        String
  description String?  @db.Text
  duration    Int
  price       Float
  enabled     Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  resident ResidentProfile  @relation(fields: [residentId], references: [id], onDelete: Cascade)
  category Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  bookings BookingService[]

  @@index([residentId])
  @@index([categoryId])
  @@map("services")
}

model Payment {
  id               String          @id @default(cuid())
  bookingId        String          @unique
  residentId       String
  stripePaymentId  String
  amount           Float
  platformFee      Float
  residentEarnings Float
  status           PaymentStatus   @default(PENDING)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  booking          Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resident         ResidentProfile @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([residentId])
  @@map("payments")
}

enum Role {
  CUSTOMER
  RESIDENT
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// NEW: Business type for residents
enum BusinessType {
  SERVICES  // Booking-based services (massage, spa, etc.)
  PRODUCTS  // Physical/digital products for sale
  BOTH      // Offer both services and products
}

// NEW: Category type
enum CategoryType {
  SERVICE
  PRODUCT
}

// NEW: Order status
enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}